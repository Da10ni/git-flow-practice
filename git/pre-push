#!/bin/sh

echo "Remote: $1"
echo "URL: $2"

# Get current branch
current_branch=$(git rev-parse --abbrev-ref HEAD)
echo "Current branch: $current_branch"

# Block direct pushes to protected branches
case "$current_branch" in
    main|master|development|develop)
        echo "" >&2
        echo "❌ =================================" >&2
        echo "❌ DIRECT PUSH BLOCKED!" >&2
        echo "❌ Branch: $current_branch" >&2
        echo "❌ Use Pull Request workflow!" >&2
        echo "❌ =================================" >&2
        echo "" >&2
        echo "✅ Correct workflow:" >&2
        echo "   1. git checkout -b feature/your-feature" >&2
        echo "   2. git push origin feature/your-feature" >&2
        echo "   3. Create Pull Request on GitHub" >&2
        echo "" >&2
        exit 1
        ;;
esac

# Check branch naming convention only
case "$current_branch" in
    hotfix/*)
        echo "✅ Hotfix branch pattern valid: $current_branch"
        
        # Optional: Check if hotfix exists on remote to determine parent
        if git ls-remote --heads origin "$current_branch" | grep -q .; then
            echo "✅ Branch already exists on remote, push allowed"
        else
            echo "ℹ️  New hotfix branch (should be from main)"
        fi
        ;;
        
    feature/*)
        echo "✅ Feature branch pattern valid: $current_branch"
        
        if git ls-remote --heads origin "$current_branch" | grep -q .; then
            echo "✅ Branch already exists on remote, push allowed"
        else
            echo "ℹ️  New feature branch (should be from development)"
        fi
        ;;
        
    release/*)
        echo "✅ Release branch pattern valid: $current_branch"
        
        if git ls-remote --heads origin "$current_branch" | grep -q .; then
            echo "✅ Branch already exists on remote, push allowed"
        else
            echo "ℹ️  New release branch (should be from development)"
        fi
        ;;
        
    bugfix/*)
        echo "✅ Bugfix branch pattern valid: $current_branch"
        ;;
        
    *)
        echo "" >&2
        echo "❌ =================================" >&2
        echo "❌ Invalid branch pattern!" >&2
        echo "❌ Your branch: $current_branch" >&2
        echo "❌ =================================" >&2
        echo "" >&2
        echo "✅ Allowed patterns:" >&2
        echo "   - feature/* (from development)" >&2
        echo "   - release/* (from development)" >&2
        echo "   - hotfix/*  (from main)" >&2
        echo "   - bugfix/*  (from any)" >&2
        echo "" >&2
        echo "Example: git branch -m feature/add-login" >&2
        echo "" >&2
        exit 1
        ;;
esac

echo "✅ Push allowed!"
exit 0